<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data:;
    font-src 'self';
    connect-src 'none';
    object-src 'none';
    base-uri 'self';
    form-action 'none';
  ">
  <title>Preferences</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #333333 0%, #4a4a4a 100%);
      color: #ffffff;
      padding: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .preferences-container {
      max-width: 500px;
      width: 100%;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
      text-align: center;
    }

    .form-group {
      background: rgba(52, 53, 64, 0.3);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid rgba(52, 53, 64, 0.5);
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      opacity: 0.9;
    }

    input[type="text"],
    input[type="url"] {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin-bottom: 6px;
    }

    input[type="text"]:focus,
    input[type="url"]:focus {
      outline: 2px solid #9b9cad;
      outline-offset: 2px;
      border-color: #9b9cad;
    }

    input[aria-invalid="true"] {
      border-color: #ff6b6b;
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .help-text {
      font-size: 11px;
      opacity: 0.6;
      line-height: 1.4;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      margin-top: 12px;
    }

    input[type="checkbox"] {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      cursor: pointer;
    }

    input[type="checkbox"]:focus {
      outline: 2px solid #9b9cad;
      outline-offset: 2px;
    }

    .checkbox-group label {
      margin: 0;
      cursor: pointer;
      font-weight: 500;
    }

    .buttons {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
    }

    button {
      background: rgba(52, 53, 64, 0.6);
      border: 1px solid rgba(52, 53, 64, 0.8);
      color: white;
      padding: 10px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      background: rgba(52, 53, 64, 0.8);
      border-color: #343540;
    }

    button:active {
      transform: scale(0.98);
    }

    button:focus {
      outline: 2px solid #9b9cad;
      outline-offset: 2px;
    }

    button:focus:not(:focus-visible) {
      outline: none;
    }

    button:focus-visible {
      outline: 2px solid #9b9cad;
      outline-offset: 2px;
    }

    button.primary {
      background: rgba(52, 53, 64, 0.9);
      border-color: #343540;
    }

    button.primary:hover {
      background: #343540;
    }

    .error {
      color: #ff6b6b;
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }

    .error.show {
      display: block;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
  </style>
</head>
<body>
  <div class="preferences-container" role="dialog" aria-labelledby="dialog-title">
    <h1 id="dialog-title">Preferences</h1>

    <div class="form-group">
      <label for="prod-url">Production Environment URL</label>
      <input
        type="url"
        id="prod-url"
        aria-describedby="prod-help prod-error"
        aria-invalid="false"
        aria-required="true"
        placeholder="https://chat.umontana.ai"
        required
      >
      <div class="help-text" id="prod-help">The URL for your production Amplify instance</div>
      <div class="error" id="prod-error" role="alert" aria-live="polite">
        Please enter a valid URL
      </div>
    </div>

    <div class="form-group">
      <label for="dev-url">Development Environment URL (Optional)</label>
      <input
        type="url"
        id="dev-url"
        aria-describedby="dev-help dev-error"
        aria-invalid="false"
        placeholder="https://dev-chat.umontana.ai"
      >
      <div class="help-text" id="dev-help">The URL for your development/staging Amplify instance</div>
      <div class="error" id="dev-error" role="alert" aria-live="polite">
        Please enter a valid URL
      </div>

      <div class="checkbox-group">
        <input
          type="checkbox"
          id="enable-dev"
          aria-describedby="dev-checkbox-help"
          checked
        >
        <label for="enable-dev">Enable development environment</label>
      </div>
      <div id="dev-checkbox-help" class="sr-only">
        When unchecked, the development environment option will be hidden from the environment switcher
      </div>
    </div>

    <div class="buttons">
      <button id="cancel-btn" type="button">Cancel</button>
      <button id="save-btn" type="button" class="primary">Save</button>
    </div>
  </div>

  <script>
    // Use secure electronAPI from preload script
    const params = window.electronAPI.getQueryParams();
    const prodUrl = params.prodUrl || '';
    const devUrl = params.devUrl || '';
    const devEnabled = params.devEnabled === 'true';

    // Populate form
    document.getElementById('prod-url').value = prodUrl;
    document.getElementById('dev-url').value = devUrl;
    document.getElementById('enable-dev').checked = devEnabled;

    // Enhanced URL validation
    function isValidUrl(string) {
      try {
        const url = new URL(string);

        // Only allow HTTP/HTTPS
        if (url.protocol !== 'http:' && url.protocol !== 'https:') {
          return false;
        }

        // Validate hostname format
        const hostnameRegex = /^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
        if (!hostnameRegex.test(url.hostname)) {
          return false;
        }

        // Warn if not HTTPS in production
        if (url.protocol === 'http:' && !url.hostname.includes('localhost') && !url.hostname.includes('127.0.0.1')) {
          console.warn('HTTP URLs are not recommended for production environments');
        }

        return true;
      } catch (_) {
        return false;
      }
    }

    // Handle save with accessibility improvements
    document.getElementById('save-btn').addEventListener('click', () => {
      const prodUrlValue = document.getElementById('prod-url').value.trim();
      const devUrlValue = document.getElementById('dev-url').value.trim();
      const devEnabledValue = document.getElementById('enable-dev').checked;

      let isValid = true;

      // Validate production URL
      if (!prodUrlValue || !isValidUrl(prodUrlValue)) {
        const input = document.getElementById('prod-url');
        const error = document.getElementById('prod-error');

        input.setAttribute('aria-invalid', 'true');
        error.classList.add('show');

        if (!isValid) {
          input.focus(); // Focus first error
        }
        isValid = false;
      } else {
        const input = document.getElementById('prod-url');
        const error = document.getElementById('prod-error');

        input.setAttribute('aria-invalid', 'false');
        error.classList.remove('show');
      }

      // Validate development URL (if provided and enabled)
      if (devEnabledValue && devUrlValue && !isValidUrl(devUrlValue)) {
        const input = document.getElementById('dev-url');
        const error = document.getElementById('dev-error');

        input.setAttribute('aria-invalid', 'true');
        error.classList.add('show');

        if (isValid) { // If prod was valid, focus dev error
          input.focus();
        }
        isValid = false;
      } else {
        const input = document.getElementById('dev-url');
        const error = document.getElementById('dev-error');

        input.setAttribute('aria-invalid', 'false');
        error.classList.remove('show');
      }

      if (!isValid) {
        return;
      }

      // Send settings to main process via secure API
      window.electronAPI.savePreferences({
        prodUrl: prodUrlValue,
        devUrl: devEnabledValue ? devUrlValue : '',
        devEnabled: devEnabledValue
      });
    });

    // Handle cancel
    document.getElementById('cancel-btn').addEventListener('click', () => {
      window.electronAPI.closeWindow();
    });

    // Toggle dev URL input based on checkbox
    document.getElementById('enable-dev').addEventListener('change', (e) => {
      const devUrlInput = document.getElementById('dev-url');
      if (!e.target.checked) {
        devUrlInput.disabled = true;
        devUrlInput.style.opacity = '0.5';
        devUrlInput.setAttribute('aria-disabled', 'true');
      } else {
        devUrlInput.disabled = false;
        devUrlInput.style.opacity = '1';
        devUrlInput.setAttribute('aria-disabled', 'false');
      }
    });

    // Initial state
    if (!devEnabled) {
      const devUrlInput = document.getElementById('dev-url');
      devUrlInput.disabled = true;
      devUrlInput.style.opacity = '0.5';
      devUrlInput.setAttribute('aria-disabled', 'true');
    }

    // Handle ESC key to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        window.electronAPI.closeWindow();
      }
    });
  </script>
</body>
</html>
